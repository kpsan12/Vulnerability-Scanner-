import schedule
import time
from scanner import ComprehensiveWebScanner
from email_utils import send_email_alert

def run_scheduled_scan(target, vuln_db_path, sender_email, receiver_email):
    print(f"Starting scan for {target} at {time.ctime()}.")
    scanner = ComprehensiveWebScanner(target, vuln_db_path)
    results = scanner.scan()

    if results:
        send_email_alert(results, sender_email, receiver_email, target)

    with open('scan_results.txt', 'w') as f:
        for result in results:
            f.write(f"{result}\n")

    print(f"Scan completed at {time.ctime()}.")

if __name__ == "__main__":
    # Configuration
    target = input("Enter the target URL to scan: ")
    vuln_db_path = r"D:\Secure coding project\vuln_database.json"
    sender_email = "Testproject326@gmail.com"
    receiver_email = "kiruthikpranav326@gmail.com"

    # Run the first scan immediately
    run_scheduled_scan(target, vuln_db_path, sender_email, receiver_email)

    # Schedule the scan to run every hour
    schedule.every(1).hours.do(run_scheduled_scan, target, vuln_db_path, sender_email, receiver_email)

    print(f"Scheduled scan for {target} every hour. Press Ctrl+C to stop.")

    try:
        while True:
            schedule.run_pending()
            time.sleep(10)  # Sleep to avoid busy-waiting
    except KeyboardInterrupt:
        print("\nStopped scanning.")
